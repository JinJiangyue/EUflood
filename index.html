<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="common.pageTitle">欧盟洪水监测系统 - 真实数据搜索</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- 项目样式 -->
    <link rel="stylesheet" href="frontend/css/main.css" />
    <link rel="stylesheet" href="frontend/css/map.css" />
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 data-i18n="common.headerTitle">🌊 欧盟洪水监测系统</h1>
            <p data-i18n="common.headerSubtitle">实时搜索真实洪水数据 - 来自官方气象API和社交媒体</p>
        </div>
        
        <div class="search-section">
            <div class="stats" id="stats">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="totalRecords">-</div>
                        <div class="stat-label" data-i18n="stats.totalRecords">总记录数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="processedRecords">-</div>
                        <div class="stat-label" data-i18n="stats.processedRecords">已处理记录</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="averageRisk">-</div>
                        <div class="stat-label" data-i18n="stats.averageRisk">平均风险</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="maxWaterLevel">-</div>
                        <div class="stat-label" data-i18n="stats.maxWaterLevel">最大水位(m)</div>
                    </div>
                </div>
            </div>
            
            <!-- 事件候选查询区域 -->
            <div class="event-candidates-section" style="padding: 20px 40px; background: #f0f4f8; border-bottom: 2px solid #e0e7ef;">
                <!-- 空间插值分析区域 -->
                <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 30px; border-left: 4px solid #e74c3c;">
                    <h2 style="margin-bottom: 15px; color: #1e3c72;" data-i18n="interpolation.title.spatialInterpolation">🗺️ 空间插值分析</h2>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;" data-i18n="file.select.dataFile">选择数据文件（CSV、Excel、TXT）</label>
                        <div style="position: relative; display: inline-block; width: 100%;">
                            <input type="file" id="interpolationFileInput" accept=".csv,.xlsx,.xls,.txt" style="position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2;">
                            <div id="customFileButton" style="padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; background: white; cursor: pointer; display: flex; align-items: center; justify-content: space-between; min-height: 42px;">
                                <span id="fileButtonText" data-i18n="file.select.chooseFile">选择文件</span>
                                <span style="color: #666; font-size: 12px;" id="fileStatusText" data-i18n="file.select.noFileChosen">未选择任何文件</span>
                            </div>
                        </div>
                        <div id="interpolationFileInfo" data-i18n="file.select.pleaseSelectFile" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666; display: none;">
                            请先选择数据文件
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;" data-i18n="interpolation.form.confirmDate">确认日期（可手动修改，用于生成事件ID）</label>
                        <input type="date" id="confirmedDateInput" lang="" style="padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; width: 220px; font-size: 14px; background: #ffffff;">
                        <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;" data-i18n="interpolation.form.dateHint">默认从文件名解析（如 20251106），可改</small>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #2c3e50;" data-i18n="interpolation.form.thresholdSetting">阈值设置（默认 50.0，可修改；显示值大于该阈值的点）</label>
                        <input type="number" id="valueThreshold" value="50.0" min="0" step="0.1" style="padding: 10px; border: 2px solid #e1e5e9; border-radius: 8px; width: 200px; font-size: 14px; background: #ffffff;">
                        <small style="display: block; margin-top: 5px; color: #666; font-size: 12px;" data-i18n="interpolation.form.thresholdHint">留空或非法时按 50.0 处理</small>
                    </div>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button id="btnUploadInterpolationFile" class="search-btn" type="button" style="flex: 1;" data-i18n="file.upload.file">📤 上传文件</button>
                        <button id="btnSaveRainEvents" class="search-btn" type="button" style="flex: 1; background: linear-gradient(135deg, #27ae60 0%, #229954 100%);" disabled data-i18n="interpolation.action.filterAndSave">💾 筛选入库</button>
                    </div>
                    <div id="interpolationStatus" style="margin-top: 15px; padding: 10px; border-radius: 5px; display: none;"></div>
                    <!-- 地图容器 -->
                    <div id="mapContainer" style="margin-top: 20px; height: 600px; border-radius: 8px; overflow: hidden; display: block; border: 2px solid #e1e5e9;">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                    <!-- 地点列表（省/市）显示区域 -->
                    <div id="interpolationPlaces" style="margin-top: 16px; background: #ffffff; border: 1px solid #e1e5e9; border-radius: 8px; padding: 12px; display: none;"></div>
                </div>
                
                <h2 style="margin-bottom: 15px; color: #1e3c72; margin-top: 40px;" data-i18n="search.title.queryRainEvents">📅 查询降雨事件（支持日期范围和国家筛选）</h2>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label style="font-size: 14px; color: #666;" data-i18n="form.startDate">开始日期:</label>
                    <input type="date" id="eventDateFrom" lang="" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;" value="">
                    <label style="font-size: 14px; color: #666;" data-i18n="form.endDate">结束日期:</label>
                    <input type="date" id="eventDateTo" lang="" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;" value="">
                    <label style="font-size: 14px; color: #666;" data-i18n="form.country">国家（可选）:</label>
                    <input type="text" id="eventCountry" data-i18n-placeholder="form.countryPlaceholder" placeholder="留空查询所有国家" style="padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; width: 200px;">
                    <button id="btnQueryEvents" class="search-btn" type="button" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" data-i18n="button.queryEvents">🔍 查询事件</button>
                    <button id="btnRefreshEvents" class="search-btn" type="button" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);" data-i18n="button.refreshQuery">🔄 刷新查询</button>
                    <span id="eventsStatus" style="color: #666; font-size: 14px;"></span>
                </div>
                <div id="candidatesList" style="margin-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="color: #1e3c72;" data-i18n="table.title.rainEventList">降雨事件列表</h3>
                    </div>
                    <div id="eventsContainer" style="display: grid; grid-template-columns: 1fr; gap: 20px; grid-template-rows: auto; transition: grid-template-columns 0.3s ease;">
                        <div id="candidatesTable" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 0; overflow-x: auto;"></div>
                        <div id="eventDetailsPanel" style="background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none; min-width: 0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #1e3c72; margin: 0;" data-i18n="detail.title.dataDetails">📊 数据详情</h3>
                                <button id="btnCloseDetails" style="background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;" data-i18n="common.close">✕ 关闭</button>
                            </div>
                            <div id="eventDetailsContent" style="max-height: 600px; overflow-y: auto;">
                                <p style="color: #999; text-align: center; padding: 40px;" data-i18n="detail.title.clickToViewDetails">点击表格中的事件行查看详细信息</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="control-bar" style="padding: 0 40px 10px 40px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button id="btnTrigger" class="search-btn" type="button" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);" data-i18n="button.triggerCheck">🌧️ 触发器检查</button>
                <button id="btnIngest" class="search-btn" type="button" data-i18n="button.ingestSample">📥 采集示例数据</button>
                <button id="btnProcess" class="search-btn" type="button" data-i18n="button.processData">⚙️ 处理数据</button>
                <button id="btnRefresh" class="search-btn" type="button" data-i18n="button.refreshStats">🔄 刷新统计</button>
                <a href="/export" target="_blank" class="search-btn" data-i18n="button.exportCSV">⬇️ 导出 CSV</a>
            </div>
            
            <form class="search-form" id="searchForm">
                <div class="form-group">
                    <label for="country" data-i18n="country.countryRegion">国家/地区</label>
                    <select id="country" name="country">
                        <option value="" data-i18n="country.allCountries">所有国家</option>
                        <option value="Spain" data-i18n="country.spain">西班牙</option>
                        <option value="Germany" data-i18n="country.germany">德国</option>
                        <option value="Italy" data-i18n="country.italy">意大利</option>
                        <option value="France" data-i18n="country.france">法国</option>
                        <option value="Denmark" data-i18n="country.denmark">丹麦</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date" data-i18n="detail.field.date">日期</label>
                    <input type="date" id="date" name="date" value="2025-10-07">
                </div>
                
                <div class="form-group">
                    <label for="severity" data-i18n="severity.severity">严重程度</label>
                    <select id="severity" name="severity">
                        <option value="" data-i18n="severity.allLevels">所有级别</option>
                        <option value="extreme" data-i18n="severity.extreme">极高</option>
                        <option value="high" data-i18n="severity.high">高</option>
                        <option value="medium" data-i18n="severity.medium">中等</option>
                        <option value="low" data-i18n="severity.low">低</option>
                    </select>
                </div>
                
                <button type="submit" class="search-btn" id="searchBtn" data-i18n="button.searchData">
                    🔍 搜索数据
                </button>
            </form>
        </div>
        
        <!-- 搜索信息显示区域 -->
        <div class="search-info-section" id="searchInfo" style="display: none;">
            <div class="search-info">
                <h4 data-i18n="search.status.smartSearchStatus">🔍 智能搜索状态</h4>
                <div id="searchInfoContent"></div>
            </div>
        </div>
        
        <div class="results-section" id="resultsSection">
            <div class="no-results">
                <h3 data-i18n="search.status.systemReady">📊 系统已就绪</h3>
                <p data-i18n="search.status.useSearchForm">使用上方搜索表单查找真实洪水数据</p>
                <p style="margin-top: 10px; font-size: 0.9em;" data-i18n="search.status.autoCollectTip">
                    💡 提示：系统每6小时自动收集最新数据
                </p>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- 国际化模块（最先加载） -->
    <script src="frontend/js/i18n.js"></script>
    
    <!-- 工具函数 -->
    <script src="frontend/js/utils.js"></script>
    
    <!-- 功能模块（按依赖顺序加载） -->
    <script src="frontend/js/modules/stats.js"></script>
    <script src="frontend/js/modules/search.js"></script>
    <script src="frontend/js/modules/events.js"></script>
    <script src="frontend/js/modules/map.js"></script>
    <script src="frontend/js/modules/interpolation.js"></script>
    <script src="frontend/js/modules/data-management.js"></script>
    
    <!-- 主入口 -->
    <script src="frontend/js/main.js"></script>
    
    <!-- 初始化国际化 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initI18n === 'function') {
                initI18n();
            }
        });
    </script>
</body>
</html>

