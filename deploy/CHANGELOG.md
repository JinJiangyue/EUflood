# Changelog

## 1.1.5 - 2025-11-14

### 🔄 重大变更
- **数据库迁移**：从 SQLite 迁移到 PocketBase（BaaS，REST API）
  - 支持远程部署，统一数据管理
  - 使用适配器模式（`IDatabaseAdapter`），便于未来扩展
  - 通过环境变量配置连接信息（`POCKETBASE_URL`、`POCKETBASE_ADMIN_EMAIL`、`POCKETBASE_ADMIN_PASSWORD`）
- **架构统一**：统一数据点导入和深度搜索的流程模式
  - Python 脚本只负责数据处理，返回 JSON 结果
  - Node.js 负责所有数据库写入操作
  - 移除了 Python 的 PocketBase 依赖

### ✨ 新增功能
- **数据库适配器**：
  - 创建 `db-adapter.ts` 接口定义
  - 实现 `PocketBaseAdapter`（`db-pocketbase.ts`）
  - 创建 `db-helper.ts` 辅助函数，统一数据库操作
- **自动分页**：PocketBase 查询自动处理 500 条分页限制
- **编码修复**：自动检测和修复 `.env` 文件编码问题（UTF-8）

### 🛠️ 技术改进
- **字段名统一**：
  - `rain_event` 表统一使用 `rain_event_id` 作为业务主键
  - 移除了所有 `id` 字段的兼容性处理
  - `rain_flood_impact` 表的 `time` 字段改为 `date`
- **去重逻辑优化**：
  - 批量查询已存在记录，使用 `Set` 进行 O(1) 查找
  - 处理浮点数精度问题（坐标保留 6 位小数）
  - 统一日期格式为 `YYYY-MM-DD`
  - 添加并发冲突检查（`rain_event_id` 唯一性）
- **错误处理增强**：
  - 批量创建时捕获重复错误，继续处理其他记录
  - 详细的错误日志和统计信息
  - 防止程序崩溃的异常处理

### 🐛 问题修复
- **详情页修复**：修复了详情页和深度搜索的 404 错误
  - 使用 `dbFind` 通过 `rain_event_id` 查询，而不是 `dbGet`（需要 PocketBase 内部 `id`）
  - 更新操作时先查询获取 PocketBase 内部 `id`
- **编码问题修复**：
  - 修复 `.env` 文件编码错误（UnicodeDecodeError）
  - 自动检测并修复编码问题（latin-1 → UTF-8）
- **代码清理**：
  - 提取重复的 `rain_event_data` 构建逻辑为 `_build_rain_event_data()` 方法
  - 移除废弃的参数和函数
  - 清理重复的导入语句
  - 简化函数签名和逻辑

### 📝 文档
- 更新 `CODE_TREE.md`：反映 PocketBase 架构变更
- 更新 `README.md`：更新数据库配置说明
- 更新 `CHANGELOG.md` 和 `DEVELOPMENT_NOTES.md`：记录本次变更

## 1.1.0 - 2025-11-11

### ✨ 新增功能
- **按地址查询降雨数据**：
  - 新增地址查询功能，支持输入城市名或具体地址查询该地址所在NUTS3区域内的降雨点数据
  - 集成OpenStreetMap Nominatim地理编码服务，自动将地址转换为坐标
  - 智能文件匹配：支持年月文件夹结构（如 `202410/`），自动查找对应日期的降雨数据文件
- **NUTS3区域精确查询**：
  - 创建 `find_nuts3.py` Python脚本，根据坐标点精确查找所在的NUTS3区域
  - 使用完整的NUTS3区域边界作为过滤条件，替代之前的固定边界框方式
  - 返回结果包含NUTS3区域名称，便于用户了解查询范围

### 🛠️ 技术改进
- **查询功能优化**：
  - 查询时默认阈值设为50（与输入框默认值一致）
  - 支持阈值模式选择（grid/fixed），与上传功能保持一致
  - 查询结果自动在地图上显示，并显示地点列表统计
- **地图图例统一**：
  - 查询页面地图添加图例控件，与首页保持一致
  - 使用固定阈值（50/100）显示高/中/低强度区间
  - 支持多语言图例文本
- **国际化完善**：
  - 修复错误消息翻译：常见错误（文件未找到、地址未找到、地理编码失败等）自动转换为当前语言
  - 修复地图标记弹窗翻译：数据点弹窗内容（数据点、经度、纬度、值）支持多语言
  - 新增查询相关翻译键：`fileNotFound`、`addressNotFound`、`geocodingFailed`、`nuts3NotFound`、`dataPoint`、`longitude`、`latitude`、`value`

### 🐛 问题修复
- **代码清理**：
  - 删除 `find_nuts3.py` 中重复的 `gpd.read_file` 调用
  - 清理前端代码中重复的注释
  - 修复翻译文件格式问题（缩进）

### 📝 文档
- 更新 i18n 资源，新增查询功能和地图弹窗相关翻译

## 1.0.9 - 2025-11-11

### ✨ 新增功能
- **最新事件专用接口**：后端新增 `/events/rain/latest`，按日期倒序返回限制条数（默认 30、最多 100），并附带时间范围概要。
- **事件页“最新”模式**：前端 `loadLatestEvents()` 调整为调用新接口，自动同步全局状态并标记 `mode: 'latest'`，默认展示最近 30 条。
- **仪表盘地图增强**：
  - 新增多语言图例控件，统一标识高/中/低雨量颜色区间。
  - 点击标记即时拉取 `/events/rain/:id`，智能展示表1（基础信息）或表2（影响评估），并高亮关键字段。

### 🛠️ 技术改进
- **地图交互重构**：
  - 提炼 `getDashboardMarkerColor()`、`ensureDashboardLegend()`、`buildDashboardPopupHtml()` 等辅助函数，分离颜色计算、图例渲染与弹窗内容生成。
  - 统一弹窗 DOM 结构，支持多行换行和 `word-break`，避免长事件 ID 溢出。
- **国际化补充**：为图例、弹窗状态、文件替换提示追加中/英/西三语言翻译键。
- **最新加载逻辑优化**：`window.appState` 会将新接口返回的日期范围写入查询参数，保持仪表盘、事件页状态一致。

### 🐛 问题修复
- **文件导入按钮文案**：上传后按钮直接显示文件名，并提示“点击可重新选择文件”，解决一直显示“选择文件”的困扰。
- **地图弹窗溢出**：调整样式后，长文本在容器内自动换行，不再撑大弹窗或遮挡地图。

### 📝 文档
- 更新 i18n 资源与前端脚本注释，覆盖图例、弹窗、文件上传等新提示。

## 1.0.7 - 2025-11-09

### ✨ 新增功能
- **多页面架构（SPA）**：
  - 侧边栏导航系统：总览仪表盘、事件查询、空间插值分析、数据分析、数据管理
  - 客户端路由系统：基于 hash 的路由（`#dashboard`, `#events` 等），无需刷新页面切换
  - 页面容器管理：每个功能模块独立页面容器，按需显示/隐藏
  - 导航状态同步：自动更新侧边栏导航的 active 状态
- **全局查询系统**：
  - 侧边栏全局查询：统一的日期范围和国家筛选
  - 快速日期选择：最新（最近30天）、今天、本周、本月
  - 查询结果共享：查询结果在所有页面间共享
  - 智能提示显示：根据当前页面自动在右侧或左侧显示查询结果
- **状态管理**：
  - 全局状态管理器：统一管理查询参数、结果、加载状态
  - 状态订阅机制：支持监听状态变化
  - 事件通知系统：通过 `globalQuery:updated` 事件通知状态变化
- **事件查询页面增强**：
  - 快速日期选择按钮：在事件查询页面上方提供快速选择
  - 默认数据加载：打开页面时自动显示最新10条事件（最近30天）
  - 分页功能完善：每页条数可配置（10/20/50/100）
  - 查询结果提示：成功/失败/无数据提示，支持多语言

### 🛠️ 技术改进
- **代码重构**：
  - 提取公共函数：`getI18n()`、`fetchEventsData()`、`showQueryResult()`、`showQueryError()`
  - 消除重复代码：统一 i18n 函数定义，减少约 100+ 行重复代码
  - 模块化优化：`global-query.js` 模块化设计，职责清晰
- **路由系统**：
  - 客户端路由：`core/router.js` 提供路由注册、导航、页面切换功能
  - 路由事件：触发 `page:show` 事件，便于模块延迟初始化
  - 地图延迟初始化：仅在空间插值页面显示时初始化地图
- **状态管理架构**：
  - `core/state-manager.js` 提供统一的状态管理接口
  - 支持状态订阅和事件通知
  - 查询结果缓存，避免重复请求
- **用户体验优化**：
  - 语言切换器位置：移动到页面右上角
  - 侧边栏标题：支持两行显示，切换语言时布局不变
  - 查询提示优化：快速查询时提示显示在右侧，避免重复提示
  - 无数据提示：查询无结果时显示友好的"没有数据"提示

### 🐛 问题修复
- 修复快速日期选择后需要再次点击查询按钮的问题：点击快速选择按钮后自动执行查询
- 修复查询无结果时仍显示旧数据的问题：正确显示"没有数据"提示并清空表格
- 修复提示信息未翻译的问题：所有提示信息支持多语言翻译
- 修复按钮重复显示放大镜图标的问题：移除重复的图标添加逻辑
- 修复事件查询页面默认无数据的问题：默认加载最新10条事件

### 📝 代码质量
- 代码行数减少：约减少 100+ 行重复代码
- 可维护性提升：公共逻辑集中管理，修改更方便
- 一致性提升：所有地方使用相同的 i18n 处理逻辑
- 可读性提升：函数职责更清晰，逻辑更简洁

## 1.0.5 - 2025-11-08

### ✨ 新增功能
- **多语言支持（i18n）**：
  - 支持中文、英文、西班牙语三种语言
  - 独立的语言包文件（`frontend/js/i18n/zh.json`, `en.json`, `es.json`）
  - 语言切换器 UI（页面右上角按钮）
  - 语言选择自动保存到 localStorage
  - 所有页面文本支持动态翻译
- **深度搜索功能完善**：
  - 表1/表2数据条件显示（根据搜索状态自动切换）
  - 深度搜索按钮和确认对话框
  - 深度搜索进度显示和详细错误信息
  - 超时时间调整为4分钟
  - 报告输出路径优化（`search_outputs/YYYYMMDD/完整ID_report.md`）

### 🛠️ 技术改进
- **数据库路径统一**：
  - 统一使用 `apps/database/dev.db` 作为数据库路径
  - 支持通过 `.env` 文件配置相对路径
  - 简化了路径解析逻辑，移除冗余的路径查找代码
- **路径配置优化**：
  - 所有路径配置支持相对路径（通过 `.env` 文件）
  - 统一路径配置：`DB_FILE`, `PYTHON_SCRIPT_DIR`, `UPLOAD_DIR`, `GEO_FILE_DIR`, `OUTPUT_DIR`
  - 地理数据文件统一位置：`apps/uploads/geofile/nuts3/` 和 `apps/uploads/geofile/city/`
- **Python 脚本重构**：
  - 将 `src/modules/python` 移动到 `apps/api/scripts`
  - 重命名 `test_search.py` 为 `deep_search.py`
  - 支持 `--json` 参数，从 JSON 文件读取事件数据
  - 优化临时文件管理（自动清理）
- **环境变量传递优化**：
  - 过滤占位符环境变量，避免覆盖 `.env` 文件中的真实值
  - 确保 Python 进程正确读取 API Keys
  - 添加环境变量检查日志
- **国际化架构**：
  - 模块化设计：独立的 `i18n.js` 模块
  - 异步加载：并行加载所有语言文件
  - 自动更新：监听语言切换事件，自动更新页面元素
  - 支持占位符替换：`t('key', { param: 'value' })`

### 🐛 问题修复
- 修复省份名称显示问题：前端正确显示省份名称（去除 `/` 后的部分）
- 修复表2 `rain_event_id` 匹配问题：确保直接复制表1的 `id`，完全匹配
- 修复表2 `date` 字段：直接复制表1的 `date` 字段（将 `time` 字段重命名为 `date`）
- 修复报告路径：使用完整事件ID和日期文件夹结构
- 修复深度搜索超时问题：超时时间从2分钟调整为4分钟
- 修复环境变量传递问题：过滤占位符值，确保 Python 从 `.env` 文件读取真实 API Keys
- 修复中文乱码问题：设置 UTF-8 编码环境变量和响应头
- 修复 TypeScript 编译错误：添加类型注解和类型断言

### 📝 文档更新
- 更新 `CODE_TREE.md`：添加国际化模块、深度搜索功能、数据库表结构说明
- 更新 `README.md`：版本号更新到 v1.0.5，添加新功能说明
- 更新 `CHANGELOG.md`：添加 v1.0.5 版本变更记录
- 更新 `DEVELOPMENT_NOTES.md`：添加国际化实现经验、深度搜索集成经验

### 🧹 代码清理
- 删除旧的 `translations.json` 文件（已拆分为独立语言文件）
- 清理冗余的路径查找代码
- 统一数据库路径引用

## 1.0.4 - 2025-11-07

### ✨ 新增功能
- **搜索管线模块**：完整的降雨事件信息搜索与报告生成系统
  - 自动地理识别：根据事件地点识别国家和官方语言
  - 多语言搜索：使用本地语言进行搜索，提高信息准确性
  - LLM 驱动处理：完全使用大语言模型（OpenAI GPT / Google Gemini）进行信息验证、提取和报告生成
  - 多源采集：支持官方来源（Tavily）、新闻（The News API）、视频（YouTube）、社交媒体（X/Instagram）
  - 智能报告生成：生成包含事件概述、时间线、多媒体来源、影响评估、总结的完整英文报告

### 🛠️ 技术改进
- **模块化架构**：
  - 参考 BettaFish 的 Agent 架构，按功能拆分为独立模块
  - 采集器动态加载，通过 `collector_config.json` 配置启用/禁用
  - 清晰的模块职责划分：地理解析、查询规划、数据采集、LLM 处理、流程编排
- **关键词优化**：
  - 地点策略：省级优先（忽略具体雨量站城市）
  - 时间格式：自然语言（如 "October 11, 2025"）
  - 查询字符串：去重、自然语言组合，避免重复关键词
- **预过滤机制**：
  - 在交给 LLM 前进行简单规则判断，减少 token 消耗
  - 智能日期提取：从 URL 和文本中自动提取日期
  - 时间、地点、关键词三重检查
  - 支持 strict（严格）和 loose（宽松）两种模式
- **成本优化**：
  - 无搜索结果时跳过 LLM 处理
  - 预过滤减少输入 token
  - 验证无相关结果时跳过后续步骤
  - 可配置的最大验证数量（默认 10 条）
- **详细日志**：
  - 完整的处理过程日志保存到 `test_log.md`
  - 包括所有 Prompt 和 LLM 响应
  - 中间结果保存：原始结果、预过滤结果、LLM 验证结果

### 📝 文档更新
- 更新 `CODE_TREE.md`：添加搜索管线模块的详细结构说明
- 更新 `search/README.md`：完整的项目说明和使用指南
- 添加 `CHANGELOG.md`：版本变更记录
- 添加 `DEVELOPMENT_NOTES.md`：开发经验总结

### 🐛 问题修复
- 修复日期提取逻辑：从 URL 和文本中正确提取日期，提高预过滤准确性
- 修复 prompt 中的降雨量引用：删除具体降雨量数值，避免匹配失败
- 修复时间窗口配置：统一为可配置项，默认从 ±3 天改为 +5 天
- 修复导入错误：添加缺失的 `datetime` 和 `Optional` 导入

### 🧹 代码清理
- 删除废弃的 `processing/` 目录（已由 LLM 替代）
- 删除废弃的 `reporting/` 目录（已由 LLM 直接生成报告）
- 清理 27 个调试和研究过程中产生的文档文件
- 清理未使用的导入和代码

## 1.0.2 - 2025-01-13

### ✨ 新增功能
- **空间插值分析增强**：
  - 阈值可配置：前端支持修改阈值（默认 50.0），不再固定
  - 行政区解析：从域 GeoJSON 自动解析国家代码（CNTR_CODE）和省名（NUTS_NAME/NAME）
  - 城市识别：从 LAU_2019.gpkg 自动获取城市名（LAU_NAME）
  - 地点列表：地图下方显示国家/省/市列表，按唯一组合统计点数
  - 国家显示：前端优先显示国家全称（Spain/United Kingdom），而非代码

### 🛠️ 技术改进
- **代码精简**：
  - 删除 NUTS 省级 sjoin 分支，避免覆盖从域 GeoJSON 解析的省名
  - 精简 LAU sjoin 逻辑，仅取 LAU_NAME 作为城市名
  - 移除冗余字段（geojson_name, lau_name, source_file）和多余日志
  - 优化字段解析：优先使用 CNTR_CODE/NUTS_NAME，兼容 NAME 字段（如 ES_Murcia）
- **文件管理**：
  - `.gitignore` 更新：忽略 uploads 目录、数据库辅助文件（.db-shm, .db-wal）、GeoJSON/GPKG 大文件
- **测试增强**：
  - `test_interpolation.py` 增强调试输出，显示域 GeoJSON 字段解析详情
  - 统计缺失省名的点，便于快速定位问题

### 🐛 问题修复
- 修复省名被 NUTS sjoin 覆盖的问题（保留域 GeoJSON 解析结果）
- 修复 sjoin 后列名后缀问题（兼容 NAME_right/NAME_left 等）
- 修复编码问题（Windows GBK 编码错误，改用 UTF-8 二进制输出）

## 1.0.1 - 2025-01-13

### ✨ 新增功能
- **前端重构**：将 `index.html` 从 1694 行重构为模块化结构
  - 创建 `frontend/` 目录，按功能拆分代码
  - CSS 提取到独立文件（`frontend/css/main.css`, `frontend/css/map.css`）
  - JavaScript 模块化：工具函数、统计数据、搜索、事件管理、地图、插值分析、数据管理
  - 主 HTML 文件精简至约 181 行（仅保留结构）
  - 保持零构建，使用原生 JavaScript
- **静态文件服务**：Express 服务器配置静态文件中间件，支持 `frontend/` 目录
  - 自动设置正确的 MIME 类型（CSS: text/css, JS: application/javascript）
- **Python 空间插值分析模块**：完整的 Python 集成，支持地理空间数据处理
  - 嵌入式 Python 环境（Python 3.12）
  - 文件上传功能（支持 CSV/TXT，制表符分隔）
  - 自动坐标转换（EPSG:3035 → WGS84）
  - 阈值筛选（固定阈值 50.0，只显示值大于 50 的点）
  - GeoJSON 空间筛选（基于多边形区域）
  - 每区域最大值点选择（每个多边形区域只保留最大值点）
  - 地图可视化集成（Leaflet.js，自动显示 GeoJSON 底图和数据点）
  - 完整的错误处理和超时机制

### 🛠️ 技术改进
- **前端模块化重构**：
  - 代码组织更清晰，每个模块职责单一
  - 全局变量管理：地图相关变量通过 `window` 对象共享
  - 模块间通信：通过全局函数和事件机制
  - 易于扩展：新增功能只需添加新模块
- Python 脚本执行器优化：批量坐标转换，提升性能
- 前端错误处理增强：详细的错误提示和解决建议
- 测试脚本支持：`test_interpolation.py` 和 `run_test.bat` 用于本地测试
- 文件读取优化：自动检测表头、支持多种分隔符

### 📝 文档更新
- 更新 README.md：添加 Python 模块使用说明
- 更新 CODE_TREE.md：添加 Python 模块结构说明
- 添加测试文档：`README_TESTING.md`

### 🐛 问题修复
- 修复 JSON 序列化错误（布尔值处理）
- 修复坐标转换性能问题（改为批量转换）
- 修复文件读取逻辑（优先使用制表符分隔）
- 修复前端错误提示（更详细的错误信息和解决建议）

## 1.0.0 - 2025-11-05
- 本地端到端跑通：采集（多源）→ 处理 → 分析 → 搜索/导出
- 新增去重 `record_id`、置信度 `confidence`、证据数 `evidence_count`、来源信息
- 搜索接口支持 `country/date/severity/q`，q 为空返回最新 50 条
- 前端 `index.html` 对接本地 API，展示置信度/来源/证据数
- 导出 CSV 包含来源、置信度、证据数与坐标等字段
- 提供 `deploy/local/run_e2e.bat` 一键脚本


